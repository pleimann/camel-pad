<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Camel Pad</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Outfit:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      *,
      *::before,
      *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      :root {
        --bg: #0c0d11;
        --surface: #131419;
        --card: #1a1b23;
        --border: #252632;
        --border-hi: #363750;
        --accent: #22d97a;
        --accent-glow: rgba(34, 217, 122, 0.22);
        --accent-dim: rgba(34, 217, 122, 0.08);
        --text: #e2e3f0;
        --muted: #7c7d96;
        --dim: #3d3e55;
        --red: #f04747;
        --red-dim: rgba(240, 71, 71, 0.1);
        --green-dim: rgba(34, 217, 122, 0.1);
        --blue: #4c8fff;
        --blue-dim: rgba(76, 143, 255, 0.1);
        --radius: 8px;
        --radius-sm: 5px;
        --mono: "JetBrains Mono", ui-monospace, "SF Mono", Menlo, monospace;
        --sans: "Outfit", -apple-system, BlinkMacSystemFont, sans-serif;
        --log-bg: #090a0e;
        --dot-color: rgba(255, 255, 255, 0.025);
        --glow-color: rgba(34, 217, 122, 0.05);
        --scanline-color: rgba(255, 255, 255, 0.012);
        --row-border: rgba(255, 255, 255, 0.03);
        --dir-sys-bg: rgba(255, 255, 255, 0.04);
      }

      /* ── Light theme ── */
      @media (prefers-color-scheme: light) {
        :root:not(.dark) {
          --bg: #f4f5f8;
          --surface: #ffffff;
          --card: #ffffff;
          --border: #e2e3ec;
          --border-hi: #c8cad6;
          --accent: #15a857;
          --accent-glow: rgba(21, 168, 87, 0.15);
          --accent-dim: rgba(21, 168, 87, 0.08);
          --text: #111218;
          --muted: #5c5d70;
          --dim: #a8a9bb;
          --red: #c82020;
          --red-dim: rgba(200, 32, 32, 0.08);
          --green-dim: rgba(21, 168, 87, 0.08);
          --blue: #1a6fd4;
          --blue-dim: rgba(26, 111, 212, 0.08);
          --log-bg: #f8f9fc;
          --dot-color: rgba(0, 0, 0, 0.04);
          --glow-color: rgba(21, 168, 87, 0.04);
          --scanline-color: rgba(0, 0, 0, 0.018);
          --row-border: rgba(0, 0, 0, 0.05);
          --dir-sys-bg: rgba(0, 0, 0, 0.05);
        }
      }

      :root.light {
        --bg: #f4f5f8;
        --surface: #ffffff;
        --card: #ffffff;
        --border: #e2e3ec;
        --border-hi: #c8cad6;
        --accent: #15a857;
        --accent-glow: rgba(21, 168, 87, 0.15);
        --accent-dim: rgba(21, 168, 87, 0.08);
        --text: #111218;
        --muted: #5c5d70;
        --dim: #a8a9bb;
        --red: #c82020;
        --red-dim: rgba(200, 32, 32, 0.08);
        --green-dim: rgba(21, 168, 87, 0.08);
        --blue: #1a6fd4;
        --blue-dim: rgba(26, 111, 212, 0.08);
        --log-bg: #f8f9fc;
        --dot-color: rgba(0, 0, 0, 0.04);
        --glow-color: rgba(21, 168, 87, 0.04);
        --scanline-color: rgba(0, 0, 0, 0.018);
        --row-border: rgba(0, 0, 0, 0.05);
        --dir-sys-bg: rgba(0, 0, 0, 0.05);
      }

      body {
        font-family: var(--sans);
        font-size: 13px;
        line-height: 1.5;
        background: var(--bg);
        background-image: radial-gradient(
            ellipse 80% 40% at 50% 0%,
            var(--glow-color) 0%,
            transparent 70%
          ),
          radial-gradient(
            circle,
            var(--dot-color) 1px,
            transparent 1px
          );
        background-size: auto, 22px 22px;
        color: var(--text);
        min-width: 480px;
        max-width: 600px;
        margin: 0 auto;
      }

      /* ── App header ── */
      .app-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 13px 20px;
        border-bottom: 1px solid var(--border);
        background: var(--surface);
      }

      .app-brand {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .app-icon {
        width: 18px;
        height: 18px;
        color: var(--accent);
        flex-shrink: 0;
      }

      .app-name {
        font-family: var(--mono);
        font-size: 11px;
        font-weight: 600;
        letter-spacing: 0.18em;
        color: var(--text);
      }

      /* ── Tab bar ── */
      .tab-bar {
        background: var(--surface);
        border-bottom: 1px solid var(--border);
        padding: 0 16px;
        display: flex;
      }

      .tab-btn {
        padding: 10px 14px;
        border: none;
        background: transparent;
        font-family: var(--sans);
        font-size: 13px;
        font-weight: 500;
        color: var(--muted);
        cursor: pointer;
        position: relative;
        transition: color 0.15s;
        white-space: nowrap;
      }

      .tab-btn:hover {
        color: var(--text);
      }

      .tab-btn.active {
        color: var(--text);
      }

      .tab-btn::after {
        content: "";
        position: absolute;
        bottom: -1px;
        left: 8px;
        right: 8px;
        height: 2px;
        background: var(--accent);
        border-radius: 2px 2px 0 0;
        opacity: 0;
        transition: opacity 0.15s;
      }

      .tab-btn.active::after {
        opacity: 1;
      }

      /* ── Content ── */
      .content {
        padding: 16px 20px 24px;
      }

      /* ── Views ── */
      .view {
        display: none;
      }
      .view.active {
        display: block;
      }

      /* ── Cards ── */
      .section,
      .ctrl-section {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 16px;
        margin-bottom: 12px;
      }

      .section h2,
      .ctrl-section h2 {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        color: var(--accent);
        margin-bottom: 14px;
      }

      .section h2::before,
      .ctrl-section h2::before {
        content: "";
        display: inline-block;
        width: 5px;
        height: 5px;
        border-radius: 50%;
        background: var(--accent);
        box-shadow: 0 0 6px var(--accent);
        flex-shrink: 0;
      }

      /* ── Connection status ── */
      .conn-banner {
        display: flex;
        align-items: center;
        gap: 7px;
        font-size: 12px;
        color: var(--muted);
      }

      .conn-dot {
        width: 7px;
        height: 7px;
        border-radius: 50%;
        background: var(--dim);
        flex-shrink: 0;
        transition:
          background 0.4s,
          box-shadow 0.4s;
      }

      .conn-dot.connected {
        background: var(--accent);
        box-shadow:
          0 0 8px var(--accent),
          0 0 16px var(--accent-glow);
        animation: led-pulse 3s ease-in-out infinite;
      }

      .conn-dot.disconnected {
        background: var(--red);
        opacity: 0.6;
      }

      .header-right {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .theme-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        border: 1px solid var(--border-hi);
        border-radius: var(--radius-sm);
        background: transparent;
        color: var(--muted);
        cursor: pointer;
        flex-shrink: 0;
        transition: all 0.15s;
        padding: 0;
      }

      .theme-toggle:hover {
        border-color: var(--accent);
        color: var(--accent);
      }

      @keyframes led-pulse {
        0%,
        100% {
          box-shadow: 0 0 5px var(--accent);
        }
        50% {
          box-shadow:
            0 0 12px var(--accent),
            0 0 24px var(--accent-glow);
        }
      }

      /* ── Settings: field rows ── */
      .field {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 6px 0;
      }

      .field label {
        flex: 0 0 152px;
        color: var(--text);
        font-size: 13px;
      }

      .field input[type="text"],
      .field input[type="number"],
      .field select {
        flex: 1;
        height: 30px;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        padding: 0 10px;
        font-size: 12.5px;
        font-family: var(--mono);
        color: var(--text);
        outline: none;
        transition:
          border-color 0.15s,
          box-shadow 0.15s;
      }

      .field input:focus,
      .field select:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 3px var(--accent-glow);
      }

      .field .hint {
        color: var(--muted);
        font-size: 11px;
        font-family: var(--mono);
        flex: 0 0 auto;
      }

      .row {
        display: flex;
        gap: 8px;
        align-items: center;
        flex: 1;
      }

      /* ── Buttons ── */
      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        height: 30px;
        padding: 0 14px;
        border-radius: var(--radius-sm);
        border: 1px solid transparent;
        cursor: pointer;
        font-size: 13px;
        font-family: var(--sans);
        font-weight: 500;
        transition: all 0.15s;
        white-space: nowrap;
        flex-shrink: 0;
      }

      .btn-primary {
        background: var(--accent);
        color: #0a0c0f;
        font-weight: 600;
        border-color: var(--accent);
      }

      .btn-primary:hover {
        background: #2af088;
      }
      .btn-primary:active {
        background: #1bc569;
      }

      .btn-secondary {
        background: transparent;
        border-color: var(--border-hi);
        color: var(--muted);
      }

      .btn-secondary:hover {
        border-color: var(--accent);
        color: var(--accent);
      }

      .btn-secondary:active {
        opacity: 0.7;
      }

      .btn-small {
        height: 26px;
        padding: 0 10px;
        font-size: 12px;
      }

      /* ── Settings footer ── */
      .footer {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        margin-top: 12px;
      }

      /* ── Device mode ── */
      .device-mode {
        display: flex;
        gap: 20px;
        margin-bottom: 14px;
      }

      .device-mode label {
        display: flex;
        align-items: center;
        gap: 7px;
        cursor: pointer;
        font-size: 13px;
        color: var(--muted);
        transition: color 0.15s;
      }

      .device-mode label:has(input:checked) {
        color: var(--text);
      }

      .device-mode input[type="radio"] {
        accent-color: var(--accent);
        width: 14px;
        height: 14px;
      }

      #port-section,
      #id-section {
        display: none;
      }

      #port-section.active,
      #id-section.active {
        display: block;
      }

      #scan-results {
        margin-top: 10px;
        display: none;
      }

      #scan-results select {
        width: 100%;
        height: 30px;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        padding: 0 10px;
        font-size: 12.5px;
        font-family: var(--mono);
        color: var(--text);
        outline: none;
      }

      /* ── Status messages ── */
      .status-msg {
        padding: 10px 14px;
        border-radius: var(--radius-sm);
        font-size: 12.5px;
        margin-top: 12px;
        display: none;
        border: 1px solid transparent;
        font-family: var(--mono);
      }

      .status-msg.success {
        background: var(--green-dim);
        color: var(--accent);
        border-color: rgba(34, 217, 122, 0.2);
        display: block;
      }

      .status-msg.error {
        background: var(--red-dim);
        color: var(--red);
        border-color: rgba(240, 71, 71, 0.2);
        display: block;
      }

      /* ── Control: ctrl-field ── */
      .ctrl-field {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        padding: 6px 0;
      }

      .ctrl-field input[type="text"] {
        flex: 1;
        min-width: 0;
        height: 30px;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        padding: 0 10px;
        font-size: 12.5px;
        font-family: var(--mono);
        color: var(--text);
        outline: none;
        transition:
          border-color 0.15s,
          box-shadow 0.15s;
      }

      .ctrl-field input[type="text"]:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 3px var(--accent-glow);
      }

      .ctrl-field input[type="text"].status-input {
        color: var(--accent);
      }

      .ctrl-field textarea {
        flex: 1;
        min-width: 0;
        height: 90px;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        padding: 8px 10px;
        font-size: 12.5px;
        font-family: var(--mono);
        color: var(--text);
        outline: none;
        resize: vertical;
        transition:
          border-color 0.15s,
          box-shadow 0.15s;
      }

      .ctrl-field textarea:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 3px var(--accent-glow);
      }

      .field-controls {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
        padding: 2px 0;
      }

      .ctrl-dim {
        font-size: 12px;
        color: var(--muted);
        white-space: nowrap;
        flex-shrink: 0;
      }

      .ctrl-fb {
        font-size: 11px;
        white-space: nowrap;
        color: transparent;
        flex-shrink: 0;
        transition: color 0.15s;
        font-family: var(--mono);
      }

      .ctrl-fb.ok {
        color: var(--accent);
      }

      .ctrl-fb.err {
        color: var(--red);
      }

      .ctrl-sub-h {
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--muted);
        padding: 10px 0 4px;
      }

      .ctrl-sub-h:first-child {
        padding-top: 0;
      }

      .ctrl-sub-sep {
        border: none;
        border-top: 1px solid var(--border);
        margin: 4px 0 0;
      }

      /* ── Label grid ── */
      .label-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 6px;
        flex: 1;
        min-width: 0;
      }

      .label-grid input[type="text"] {
        width: 100%;
        height: 28px;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        padding: 0 6px;
        font-size: 11.5px;
        font-family: var(--mono);
        color: var(--text);
        outline: none;
        min-width: 0;
      }

      .label-grid input[type="text"]:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 2px var(--accent-glow);
      }

      /* ── LED grid ── */
      .led-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
        flex: 1;
        min-width: 0;
      }

      .led-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
        font-size: 10px;
        font-family: var(--mono);
        color: var(--muted);
        letter-spacing: 0.05em;
      }

      .led-item input[type="color"] {
        -webkit-appearance: none;
        width: 100%;
        height: 36px;
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        padding: 3px;
        cursor: pointer;
        background: var(--bg);
        transition:
          border-color 0.15s,
          box-shadow 0.15s;
      }

      .led-item input[type="color"]::-webkit-color-swatch-wrapper {
        padding: 0;
      }

      .led-item input[type="color"]::-webkit-color-swatch {
        border: none;
        border-radius: 3px;
      }

      .led-item input[type="color"]:hover {
        border-color: var(--border-hi);
      }

      /* ── Monitor ── */
      .mon-toolbar {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 10px;
      }

      .mon-toolbar input[type="text"] {
        flex: 1;
        height: 30px;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        padding: 0 10px;
        font-size: 12px;
        font-family: var(--mono);
        color: var(--text);
        outline: none;
        transition:
          border-color 0.15s,
          box-shadow 0.15s;
      }

      .mon-toolbar input[type="text"]:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 3px var(--accent-glow);
      }

      .mon-toolbar label {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 12px;
        color: var(--muted);
        white-space: nowrap;
        cursor: pointer;
      }

      .mon-toolbar input[type="checkbox"] {
        accent-color: var(--accent);
        width: 14px;
        height: 14px;
      }

      .mon-log {
        background: var(--log-bg);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        height: 340px;
        overflow-y: auto;
        font-family: var(--mono);
        font-size: 11.5px;
        background-image: repeating-linear-gradient(
          to bottom,
          transparent,
          transparent 19px,
          var(--scanline-color) 19px,
          var(--scanline-color) 20px
        );
      }

      .mon-log:empty::after {
        content: "No events yet…";
        display: block;
        padding: 20px;
        color: var(--dim);
        text-align: center;
        font-size: 12px;
      }

      .log-row {
        display: flex;
        align-items: baseline;
        gap: 8px;
        padding: 5px 12px;
        border-bottom: 1px solid var(--row-border);
        line-height: 1.5;
      }

      .log-row:last-child {
        border-bottom: none;
      }

      .log-row.filtered {
        display: none;
      }

      .log-ts {
        color: var(--dim);
        flex-shrink: 0;
        font-size: 10.5px;
      }

      .log-dir {
        flex-shrink: 0;
        font-size: 9.5px;
        font-weight: 600;
        letter-spacing: 0.06em;
        padding: 1px 5px;
        border-radius: 3px;
        width: 32px;
        text-align: center;
      }

      .log-dir-in {
        background: var(--green-dim);
        color: var(--accent);
      }

      .log-dir-out {
        background: var(--blue-dim);
        color: var(--blue);
      }

      .log-dir-sys {
        background: var(--dir-sys-bg);
        color: var(--muted);
      }

      .log-type {
        color: var(--muted);
        flex-shrink: 0;
        min-width: 90px;
        font-size: 11px;
      }

      .log-summary {
        color: var(--text);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        flex: 1;
        font-size: 11.5px;
      }

      /* ── Keys view ── */
      .kb-hint {
        font-size: 12px;
        color: var(--muted);
        margin-bottom: 14px;
        line-height: 1.6;
        padding: 10px 14px;
        background: var(--accent-dim);
        border: 1px solid rgba(34, 217, 122, 0.12);
        border-radius: var(--radius-sm);
      }

      .kb-col-header {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 0 0 6px;
        border-bottom: 1px solid var(--border);
        margin-bottom: 6px;
      }

      .kb-gesture-label {
        flex: 0 0 96px;
        font-size: 13px;
        color: var(--text);
      }

      .kb-col-name {
        flex: 1;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--muted);
      }

      .kb-gesture-row {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 5px 0;
      }

      .kb-gesture-row input[type="text"] {
        flex: 1;
        min-width: 0;
        height: 28px;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        padding: 0 8px;
        font-size: 12.5px;
        font-family: var(--mono);
        color: var(--text);
        outline: none;
        transition:
          border-color 0.15s,
          box-shadow 0.15s;
      }

      .kb-gesture-row input[type="text"]:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 2px var(--accent-glow);
      }

      /* ── Notify result ── */
      .notify-result {
        font-size: 12px;
        padding: 8px 12px;
        border-radius: var(--radius-sm);
        background: var(--surface);
        color: var(--muted);
        margin-top: 8px;
        display: none;
        border: 1px solid var(--border);
        font-family: var(--mono);
      }

      .notify-result.visible {
        display: block;
      }

      .notify-result.ok {
        background: var(--green-dim);
        color: var(--accent);
        border-color: rgba(34, 217, 122, 0.2);
      }

      .notify-result.err {
        background: var(--red-dim);
        color: var(--red);
        border-color: rgba(240, 71, 71, 0.2);
      }

      /* ── Select styling ── */
      select {
        -webkit-appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%237c7d96' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 10px center;
        padding-right: 28px !important;
      }

      /* ── Scrollbar ── */
      ::-webkit-scrollbar {
        width: 5px;
      }

      ::-webkit-scrollbar-track {
        background: var(--bg);
      }

      ::-webkit-scrollbar-thumb {
        background: var(--border-hi);
        border-radius: 10px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: var(--muted);
      }
    </style>
    <script>
      // Apply saved theme before render to prevent flash
      (function () {
        const t = localStorage.getItem("camel-pad-theme");
        if (t === "light") document.documentElement.classList.add("light");
        else if (t === "dark") document.documentElement.classList.add("dark");
      })();
    </script>
  </head>
  <body>
    <!-- App header with brand + connection status -->
    <header class="app-header">
      <div class="app-brand">
        <svg
          class="app-icon"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="1.8"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <rect x="2" y="2" width="9" height="9" rx="1.5" />
          <rect x="13" y="2" width="9" height="9" rx="1.5" />
          <rect x="2" y="13" width="9" height="9" rx="1.5" />
          <rect x="13" y="13" width="9" height="9" rx="1.5" />
        </svg>
        <span class="app-name">CAMEL PAD</span>
      </div>
      <div class="header-right">
        <div class="conn-banner">
          <span class="conn-dot disconnected" id="conn-dot"></span>
          <span id="conn-label">Checking…</span>
        </div>
        <button
          class="theme-toggle"
          id="theme-toggle"
          onclick="toggleTheme()"
          title="Toggle theme"
          aria-label="Toggle theme"
        ></button>
      </div>
    </header>

    <!-- Tab bar -->
    <nav class="tab-bar">
      <button
        class="tab-btn active"
        data-tab="control"
        onclick="switchTab('control')"
      >
        Control
      </button>
      <button
        class="tab-btn"
        data-tab="settings"
        onclick="switchTab('settings')"
      >
        Settings
      </button>
      <button class="tab-btn" data-tab="keys" onclick="switchTab('keys')">
        Keys
      </button>
      <button
        class="tab-btn"
        data-tab="monitor"
        onclick="switchTab('monitor')"
      >
        Monitor
      </button>
    </nav>

    <div class="content">
      <!-- ═══════════════════════════════════════════════════════════════
           CONTROL VIEW
           ═══════════════════════════════════════════════════════════════ -->
      <div id="view-control" class="view active">
        <div class="ctrl-section">
          <h2>Display</h2>

          <div class="ctrl-field">
            <input
              type="text"
              id="ctrl-status"
              class="status-input"
              placeholder="Status bar text…"
            />
            <div class="field-controls">
              <button
                type="button"
                class="btn btn-secondary btn-small"
                onclick="sendStatusText()"
              >
                Send
              </button>
              <span class="ctrl-fb" id="fb-status"></span>
            </div>
          </div>

          <div class="ctrl-field">
            <textarea
              id="ctrl-text"
              placeholder="Text to show on display…"
            ></textarea>
            <div class="field-controls">
              <button
                type="button"
                class="btn btn-secondary btn-small"
                onclick="sendDisplayText()"
              >
                Send
              </button>
              <span class="ctrl-fb" id="fb-text"></span>
            </div>
          </div>

          <div class="ctrl-field">
            <button
              type="button"
              class="btn btn-secondary btn-small"
              onclick="clearDisplay()"
            >
              Clear Display
            </button>
            <span class="ctrl-fb" id="fb-clear"></span>
          </div>
        </div>

        <div class="ctrl-section">
          <h2>Buttons</h2>

          <p class="ctrl-sub-h">LED Colors</p>
          <div class="ctrl-field">
            <div class="led-grid">
              <div class="led-item">
                <input
                  type="color"
                  id="led0"
                  value="#000000"
                  oninput="sendLeds()"
                />
                <span>Key 1</span>
              </div>
              <div class="led-item">
                <input
                  type="color"
                  id="led1"
                  value="#000000"
                  oninput="sendLeds()"
                />
                <span>Key 2</span>
              </div>
              <div class="led-item">
                <input
                  type="color"
                  id="led2"
                  value="#000000"
                  oninput="sendLeds()"
                />
                <span>Key 3</span>
              </div>
              <div class="led-item">
                <input
                  type="color"
                  id="led3"
                  value="#000000"
                  oninput="sendLeds()"
                />
                <span>Key 4</span>
              </div>
            </div>
            <span class="ctrl-fb" id="fb-leds"></span>
          </div>
        </div>

        <!-- Notification tester (commented out)
        <div class="ctrl-section">
          <h2>Notifications</h2>
          <div class="ctrl-field">
            <input type="text" id="notify-text" placeholder="Notification text…" />
            <button type="button" class="btn btn-secondary btn-small" onclick="sendNotify()">Send</button>
          </div>
          <div class="ctrl-field">
            <input type="text" id="notify-category" placeholder="Category (optional)..." />
          </div>
          <div class="notify-result" id="notify-result"></div>
        </div>
        -->
      </div>
      <!-- /view-control -->

      <!-- ═══════════════════════════════════════════════════════════════
           SETTINGS VIEW
           ═══════════════════════════════════════════════════════════════ -->
      <div id="view-settings" class="view">
        <div class="section">
          <h2>Device</h2>

          <div class="device-mode">
            <label
              ><input type="radio" name="deviceMode" value="port" checked />
              Serial Port</label
            >
            <label
              ><input type="radio" name="deviceMode" value="ids" />
              Vendor/Product ID</label
            >
          </div>

          <div id="port-section" class="active">
            <div class="field">
              <label>Serial Port</label>
              <div class="row">
                <input
                  type="text"
                  id="port"
                  placeholder="/dev/cu.usbmodem..."
                />
                <button
                  type="button"
                  class="btn btn-secondary btn-small"
                  id="scan-btn"
                  onclick="scanDevices()"
                >
                  Scan
                </button>
              </div>
            </div>
            <div id="scan-results">
              <select
                id="port-select"
                onchange="document.getElementById('port').value = this.value"
              >
                <option value="">Select a device...</option>
              </select>
            </div>
          </div>

          <div id="id-section">
            <div class="field">
              <label>Vendor ID</label>
              <input type="text" id="vendorId" placeholder="0x303A" />
              <span class="hint">hex</span>
            </div>
            <div class="field">
              <label>Product ID</label>
              <input type="text" id="productId" placeholder="0x1001" />
              <span class="hint">hex</span>
            </div>
          </div>
        </div>

        <div class="section">
          <h2>Orientation</h2>
          <div class="device-mode">
            <label
              ><input
                type="radio"
                name="handedness"
                value="right"
                checked
              />
              Right-handed</label
            >
            <label
              ><input type="radio" name="handedness" value="left" />
              Left-handed</label
            >
          </div>
        </div>

        <div class="section">
          <h2>Gestures</h2>
          <div class="field">
            <label>Long Press</label>
            <input
              type="number"
              id="longPressMs"
              min="100"
              max="5000"
              step="50"
            />
            <span class="hint">ms</span>
          </div>
          <div class="field">
            <label>Double Press Window</label>
            <input
              type="number"
              id="doublePressMs"
              min="50"
              max="2000"
              step="50"
            />
            <span class="hint">ms</span>
          </div>
        </div>

        <div class="section">
          <h2>Server</h2>
          <div class="field">
            <label>WebSocket Port</label>
            <input type="number" id="serverPort" min="1024" max="65535" />
          </div>
          <div class="field">
            <label>Host</label>
            <input type="text" id="serverHost" placeholder="localhost" />
          </div>
        </div>

        <div class="section">
          <h2>Notification Timeout</h2>
          <div class="field">
            <label>Timeout</label>
            <input
              type="number"
              id="timeoutMs"
              min="1000"
              max="300000"
              step="1000"
            />
            <span class="hint">ms</span>
          </div>
        </div>

        <div id="status-msg" class="status-msg"></div>

        <div class="footer">
          <button
            type="button"
            class="btn btn-secondary"
            onclick="window.close()"
          >
            Cancel
          </button>
          <button type="button" class="btn btn-primary" onclick="saveConfig()">
            Save
          </button>
        </div>
      </div>
      <!-- /view-settings -->

      <!-- ═══════════════════════════════════════════════════════════════
           KEYS VIEW
           ═══════════════════════════════════════════════════════════════ -->
      <div id="view-keys" class="view">
        <!-- Key cards are generated by renderKeybindings() -->
      </div>
      <!-- /view-keys -->

      <!-- ═══════════════════════════════════════════════════════════════
           MONITOR VIEW
           ═══════════════════════════════════════════════════════════════ -->
      <div id="view-monitor" class="view">
        <div class="mon-toolbar">
          <input
            type="text"
            id="mon-filter"
            placeholder="Filter…"
            oninput="applyMonitorFilter()"
          />
          <label><input type="checkbox" id="mon-pause" /> Pause</label>
          <button
            type="button"
            class="btn btn-secondary btn-small"
            onclick="clearMonitorLog()"
          >
            Clear
          </button>
        </div>
        <div class="mon-log" id="mon-log"></div>
      </div>
      <!-- /view-monitor -->
    </div>
    <!-- /content -->

    <script>
      // ── Theme toggle ─────────────────────────────────────────────────

      const ICON_SUN = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="2" x2="12" y2="4"/><line x1="12" y1="20" x2="12" y2="22"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="2" y1="12" x2="4" y2="12"/><line x1="20" y1="12" x2="22" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>`;
      const ICON_MOON = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>`;

      function getEffectiveTheme() {
        const cl = document.documentElement.classList;
        if (cl.contains("light")) return "light";
        if (cl.contains("dark")) return "dark";
        return window.matchMedia("(prefers-color-scheme: dark)").matches
          ? "dark"
          : "light";
      }

      function updateThemeIcon() {
        const btn = document.getElementById("theme-toggle");
        if (btn)
          btn.innerHTML =
            getEffectiveTheme() === "dark" ? ICON_SUN : ICON_MOON;
      }

      function toggleTheme() {
        const cl = document.documentElement.classList;
        const current = getEffectiveTheme();
        cl.remove("light", "dark");
        if (current === "dark") {
          cl.add("light");
          localStorage.setItem("camel-pad-theme", "light");
        } else {
          cl.add("dark");
          localStorage.setItem("camel-pad-theme", "dark");
        }
        updateThemeIcon();
      }

      window
        .matchMedia("(prefers-color-scheme: dark)")
        .addEventListener("change", updateThemeIcon);

      // ─────────────────────────────────────────────────────────────────

      let currentConfig = null;
      let statusPollInterval = null;

      // ── Tab switching ────────────────────────────────────────────────

      function switchTab(tab) {
        document.querySelectorAll(".tab-btn").forEach((b) => {
          b.classList.toggle("active", b.dataset.tab === tab);
        });
        document
          .getElementById("view-control")
          .classList.toggle("active", tab === "control");
        document
          .getElementById("view-settings")
          .classList.toggle("active", tab === "settings");
        document
          .getElementById("view-keys")
          .classList.toggle("active", tab === "keys");
        document
          .getElementById("view-monitor")
          .classList.toggle("active", tab === "monitor");
        if (tab === "monitor") startMonitorPolling();
        else stopMonitorPolling();
      }

      // ── Monitor view ─────────────────────────────────────────────────

      let monitorPollInterval = null;
      let monitorCursor = 0;

      function fmtTime(ts) {
        const d = new Date(ts);
        return (
          d.toLocaleTimeString("en-US", { hour12: false }) +
          "." +
          String(d.getMilliseconds()).padStart(3, "0")
        );
      }

      function appendLogEntries(entries) {
        if (!entries.length) return;
        const log = document.getElementById("mon-log");
        const filter = document
          .getElementById("mon-filter")
          .value.toLowerCase();
        const paused = document.getElementById("mon-pause").checked;
        const atBottom =
          log.scrollHeight - log.scrollTop <= log.clientHeight + 4;

        for (const e of entries) {
          const row = document.createElement("div");
          row.className = "log-row";
          row.dataset.text = `${e.type} ${e.summary}`.toLowerCase();

          const ts = document.createElement("span");
          ts.className = "log-ts";
          ts.textContent = fmtTime(e.ts);

          const dir = document.createElement("span");
          dir.className = `log-dir log-dir-${e.dir}`;
          dir.textContent = e.dir.toUpperCase();

          const type = document.createElement("span");
          type.className = "log-type";
          type.textContent = e.type;

          const summary = document.createElement("span");
          summary.className = "log-summary";
          summary.textContent = e.summary;

          row.append(ts, dir, type, summary);

          if (filter && !row.dataset.text.includes(filter)) {
            row.classList.add("filtered");
          }

          log.appendChild(row);
        }

        // Cap at 1000 visible rows
        while (log.children.length > 1000) log.removeChild(log.firstChild);

        if (!paused && atBottom) log.scrollTop = log.scrollHeight;
      }

      async function pollMonitorLogs() {
        try {
          const res = await fetch(`/api/logs?since=${monitorCursor}`);
          const { entries, cursor } = await res.json();
          monitorCursor = cursor;
          appendLogEntries(entries);
        } catch {
          /* ignore */
        }
      }

      function startMonitorPolling() {
        if (monitorPollInterval) return;
        pollMonitorLogs();
        monitorPollInterval = setInterval(pollMonitorLogs, 1000);
      }

      function stopMonitorPolling() {
        if (monitorPollInterval) {
          clearInterval(monitorPollInterval);
          monitorPollInterval = null;
        }
      }

      function clearMonitorLog() {
        document.getElementById("mon-log").innerHTML = "";
      }

      function applyMonitorFilter() {
        const filter = document
          .getElementById("mon-filter")
          .value.toLowerCase();
        document.querySelectorAll("#mon-log .log-row").forEach((row) => {
          row.classList.toggle(
            "filtered",
            !!filter && !row.dataset.text.includes(filter),
          );
        });
      }

      // ── Keys view ────────────────────────────────────────────────────

      const KB_KEY_NAMES = ["Key 1", "Key 2", "Key 3", "Key 4"];
      const KB_GESTURES = [
        { id: "press", snake: "press", label: "Press" },
        { id: "doublePress", snake: "double_press", label: "Double Press" },
        { id: "longPress", snake: "long_press", label: "Long Press" },
      ];

      function renderKeybindings(keys) {
        const container = document.getElementById("view-keys");
        container.innerHTML = "";

        // Intro hint
        const hint = document.createElement("p");
        hint.className = "kb-hint";
        hint.textContent =
          "Map each button gesture to an action returned to Claude Code. " +
          'Action is the value sent on response (e.g. "approve"); ' +
          'Label is shown on the device display (e.g. "Yes").';
        container.appendChild(hint);

        for (let i = 0; i < 4; i++) {
          const keyId = "key" + i;
          const keyMapping = keys[keyId] || {};

          const card = document.createElement("div");
          card.className = "section";

          const title = document.createElement("h2");
          title.textContent = KB_KEY_NAMES[i];
          card.appendChild(title);

          // Column headers
          const header = document.createElement("div");
          header.className = "kb-col-header";
          header.innerHTML =
            '<span class="kb-gesture-label"></span>' +
            '<span class="kb-col-name">Action</span>' +
            '<span class="kb-col-name">Label</span>';
          card.appendChild(header);

          for (const g of KB_GESTURES) {
            const mapping = keyMapping[g.id] || keyMapping[g.snake] || {};

            const row = document.createElement("div");
            row.className = "kb-gesture-row";

            const lbl = document.createElement("span");
            lbl.className = "kb-gesture-label";
            lbl.textContent = g.label;

            // Support both the action/label format and the older keys:[...] format.
            // If only keys is present, seed action with the joined sequence so the
            // user can see and edit what they previously had in their config.
            const keysStr = Array.isArray(mapping.keys)
              ? mapping.keys.join(", ")
              : "";

            const actionIn = document.createElement("input");
            actionIn.type = "text";
            actionIn.id = "kb-" + keyId + "-" + g.id + "-action";
            actionIn.value = mapping.action || keysStr;
            actionIn.placeholder = "e.g. approve";

            const labelIn = document.createElement("input");
            labelIn.type = "text";
            labelIn.id = "kb-" + keyId + "-" + g.id + "-label";
            labelIn.value = mapping.label || "";
            labelIn.placeholder = "e.g. Yes";

            row.append(lbl, actionIn, labelIn);
            card.appendChild(row);
          }

          container.appendChild(card);
        }

        // Status message
        const statusMsg = document.createElement("div");
        statusMsg.id = "kb-status-msg";
        statusMsg.className = "status-msg";
        container.appendChild(statusMsg);

        // Footer with Save button
        const footer = document.createElement("div");
        footer.className = "footer";
        footer.innerHTML =
          '<button type="button" class="btn btn-secondary" onclick="window.close()">Cancel</button>' +
          '<button type="button" class="btn btn-primary" onclick="saveKeybindings()">Save</button>';
        container.appendChild(footer);
      }

      function collectKeybindings() {
        const keys = {};
        for (let i = 0; i < 4; i++) {
          const keyId = "key" + i;
          const keyMapping = {};
          for (const g of KB_GESTURES) {
            const actionEl = document.getElementById(
              "kb-" + keyId + "-" + g.id + "-action",
            );
            const labelEl = document.getElementById(
              "kb-" + keyId + "-" + g.id + "-label",
            );
            if (!actionEl || !labelEl) continue;
            const action = actionEl.value.trim();
            const label = labelEl.value.trim();
            if (action || label) {
              keyMapping[g.id] = { action, label };
            }
          }
          if (Object.keys(keyMapping).length > 0) {
            keys[keyId] = keyMapping;
          }
        }
        return keys;
      }

      async function saveKeybindings() {
        const keys = collectKeybindings();
        const config = { ...currentConfig, keys };
        try {
          const res = await fetch("/api/config", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(config),
          });
          if (!res.ok) {
            showKbStatus("Save failed: " + (await res.text()), "error");
            return;
          }
          currentConfig = config;
          showKbStatus(
            "Keybindings saved. camel-pad will reload the config.",
            "success",
          );
          setTimeout(() => fetch("/api/close").catch(() => {}), 1500);
        } catch (e) {
          showKbStatus("Save failed: " + e.message, "error");
        }
      }

      function showKbStatus(msg, type) {
        const el = document.getElementById("kb-status-msg");
        el.textContent = msg;
        el.className = "status-msg " + type;
      }

      // ── Settings view ────────────────────────────────────────────────

      document.querySelectorAll('input[name="deviceMode"]').forEach((radio) => {
        radio.addEventListener("change", () => {
          const mode = document.querySelector(
            'input[name="deviceMode"]:checked',
          ).value;
          document
            .getElementById("port-section")
            .classList.toggle("active", mode === "port");
          document
            .getElementById("id-section")
            .classList.toggle("active", mode === "ids");
        });
      });

      async function loadConfig() {
        let config;
        try {
          const res = await fetch("/api/config");
          config = await res.json();
          currentConfig = config;
        } catch (e) {
          showStatus("Failed to load config: " + e.message, "error");
          return;
        }
        try {
          populateForm(config);
        } catch (e) {
          showStatus("Failed to populate settings form: " + e.message, "error");
        }
        renderKeybindings(config.keys ?? {});
      }

      function populateForm(config) {
        const hasPort = !!config.device?.port;
        const hasIds = !!(config.device?.vendorId && config.device?.productId);

        if (hasPort) {
          document.querySelector(
            'input[name="deviceMode"][value="port"]',
          ).checked = true;
          document.getElementById("port-section").classList.add("active");
          document.getElementById("id-section").classList.remove("active");
          document.getElementById("port").value = config.device.port || "";
        } else if (hasIds) {
          document.querySelector(
            'input[name="deviceMode"][value="ids"]',
          ).checked = true;
          document.getElementById("port-section").classList.remove("active");
          document.getElementById("id-section").classList.add("active");
          document.getElementById("vendorId").value = config.device.vendorId
            ? "0x" + config.device.vendorId.toString(16)
            : "";
          document.getElementById("productId").value = config.device.productId
            ? "0x" + config.device.productId.toString(16)
            : "";
        }

        const handedness = config.handedness ?? "right";
        document.querySelector(
          `input[name="handedness"][value="${handedness}"]`,
        ).checked = true;

        document.getElementById("longPressMs").value =
          config.gestures?.longPressMs ?? 500;
        document.getElementById("doublePressMs").value =
          config.gestures?.doublePressMs ?? 300;
        document.getElementById("serverPort").value =
          config.server?.port ?? 52914;
        document.getElementById("serverHost").value =
          config.server?.host ?? "localhost";
        document.getElementById("timeoutMs").value =
          config.defaults?.timeoutMs ?? 30000;
      }

      async function scanDevices() {
        const btn = document.getElementById("scan-btn");
        btn.textContent = "Scanning...";
        btn.disabled = true;
        try {
          const res = await fetch("/api/devices");
          const devices = await res.json();
          const select = document.getElementById("port-select");
          select.innerHTML = '<option value="">Select a device...</option>';
          devices.length === 0
            ? (select.innerHTML +=
                '<option value="" disabled>No devices found</option>')
            : devices.forEach((d) => {
                const label = d.vendorId
                  ? `${d.path}  [${d.vendorId}:${d.productId}]`
                  : d.path;
                select.innerHTML += `<option value="${d.path}">${label}</option>`;
              });
          document.getElementById("scan-results").style.display = "block";
        } catch (e) {
          showStatus("Scan failed: " + e.message, "error");
        } finally {
          btn.textContent = "Scan";
          btn.disabled = false;
        }
      }

      async function saveConfig() {
        const mode = document.querySelector(
          'input[name="deviceMode"]:checked',
        ).value;
        const config = {
          device: {},
          gestures: {
            longPressMs: parseInt(document.getElementById("longPressMs").value),
            doublePressMs: parseInt(
              document.getElementById("doublePressMs").value,
            ),
          },
          server: {
            port: parseInt(document.getElementById("serverPort").value),
            host: document.getElementById("serverHost").value.trim(),
          },
          defaults: {
            timeoutMs: parseInt(document.getElementById("timeoutMs").value),
          },
          keys: currentConfig?.keys ?? {},
          handedness: document.querySelector('input[name="handedness"]:checked')
            .value,
        };

        if (mode === "port") {
          const port = document.getElementById("port").value.trim();
          if (!port) {
            showStatus("Please enter a serial port path.", "error");
            return;
          }
          config.device.port = port;
        } else {
          const vid = parseInt(
            document.getElementById("vendorId").value.trim(),
            16,
          );
          const pid = parseInt(
            document.getElementById("productId").value.trim(),
            16,
          );
          if (!vid || !pid) {
            showStatus("Please enter valid vendor and product IDs.", "error");
            return;
          }
          config.device.vendorId = vid;
          config.device.productId = pid;
        }

        try {
          const res = await fetch("/api/config", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(config),
          });
          if (!res.ok) {
            showStatus("Save failed: " + (await res.text()), "error");
            return;
          }
          showStatus(
            "Settings saved. camel-pad will reconnect with the new config.",
            "success",
          );
          setTimeout(() => fetch("/api/close").catch(() => {}), 1500);
        } catch (e) {
          showStatus("Save failed: " + e.message, "error");
        }
      }

      function showStatus(msg, type) {
        const el = document.getElementById("status-msg");
        el.textContent = msg;
        el.className = "status-msg " + type;
      }

      // ── Control view ─────────────────────────────────────────────────

      async function updateConnectionStatus() {
        try {
          const res = await fetch("/api/status");
          const s = await res.json();
          const dot = document.getElementById("conn-dot");
          const lbl = document.getElementById("conn-label");
          if (s.connected) {
            dot.className = "conn-dot connected";
            lbl.textContent =
              "Connected" + (s.portPath ? " — " + s.portPath : "");
          } else {
            dot.className = "conn-dot disconnected";
            lbl.textContent = "Not connected";
          }
        } catch {
          /* ignore */
        }
      }

      function setFb(id, msg, isOk) {
        const el = document.getElementById(id);
        el.textContent = msg;
        el.className = "ctrl-fb " + (isOk ? "ok" : "err");
        setTimeout(() => {
          el.textContent = "";
          el.className = "ctrl-fb";
        }, 3000);
      }

      async function devicePost(path, body) {
        const res = await fetch(path, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
        return res.json();
      }

      async function sendDisplayText() {
        const text = document.getElementById("ctrl-text").value;
        try {
          const r = await devicePost("/api/device/text", { text });
          setFb("fb-text", r.ok ? "Sent" : r.error, r.ok);
        } catch (e) {
          setFb("fb-text", e.message, false);
        }
      }

      async function sendStatusText() {
        const text = document.getElementById("ctrl-status").value;
        try {
          const r = await devicePost("/api/device/status-text", { text });
          setFb("fb-status", r.ok ? "Sent" : r.error, r.ok);
        } catch (e) {
          setFb("fb-status", e.message, false);
        }
      }

      async function clearDisplay() {
        try {
          const r = await devicePost("/api/device/clear", {});
          setFb("fb-clear", r.ok ? "Cleared" : r.error, r.ok);
        } catch (e) {
          setFb("fb-clear", e.message, false);
        }
      }

      async function sendLabels() {
        const labels = [0, 1, 2, 3].map(
          (i) => document.getElementById("lbl" + i).value,
        );
        try {
          const r = await devicePost("/api/device/labels", { labels });
          setFb("fb-labels", r.ok ? "Applied" : r.error, r.ok);
        } catch (e) {
          setFb("fb-labels", e.message, false);
        }
      }

      function hexToRgb(hex) {
        const n = parseInt(hex.slice(1), 16);
        return { r: (n >> 16) & 0xff, g: (n >> 8) & 0xff, b: n & 0xff };
      }

      async function sendLeds() {
        const leds = [0, 1, 2, 3].map((i) => {
          const { r, g, b } = hexToRgb(
            document.getElementById("led" + i).value,
          );
          return { index: i, r, g, b };
        });
        try {
          const r = await devicePost("/api/device/leds", { leds });
          setFb("fb-leds", r.ok ? "✓" : r.error, r.ok);
        } catch (e) {
          setFb("fb-leds", e.message, false);
        }
      }

      async function sendNotify() {
        const text = document.getElementById("notify-text").value.trim();
        const category =
          document.getElementById("notify-category").value.trim() || undefined;
        const resultEl = document.getElementById("notify-result");

        if (!text) {
          resultEl.textContent = "Enter notification text first.";
          resultEl.className = "notify-result visible err";
          return;
        }

        const wsPort = currentConfig?.server?.port ?? 52914;
        const id = crypto.randomUUID();

        resultEl.textContent = "Waiting for response…";
        resultEl.className = "notify-result visible";

        let ws;
        try {
          ws = new WebSocket("ws://localhost:" + wsPort);
        } catch (e) {
          resultEl.textContent = "WebSocket error: " + e.message;
          resultEl.className = "notify-result visible err";
          return;
        }

        const timeout = setTimeout(() => {
          ws.close();
          resultEl.textContent = "Timed out waiting for response.";
          resultEl.className = "notify-result visible err";
        }, 30000);

        ws.onopen = () => {
          ws.send(
            JSON.stringify({
              type: "notification",
              id,
              text,
              ...(category ? { category } : {}),
            }),
          );
        };

        ws.onmessage = (evt) => {
          try {
            const msg = JSON.parse(evt.data);
            if (msg.id !== id) return;
            clearTimeout(timeout);
            ws.close();
            if (msg.type === "response") {
              resultEl.textContent =
                'Response: action="' +
                msg.action +
                '" label="' +
                msg.label +
                '"';
              resultEl.className = "notify-result visible ok";
            } else if (msg.type === "error") {
              resultEl.textContent = "Error: " + msg.error;
              resultEl.className = "notify-result visible err";
            }
          } catch {
            /* ignore non-JSON */
          }
        };

        ws.onerror = () => {
          clearTimeout(timeout);
          resultEl.textContent = "Could not connect to WebSocket server.";
          resultEl.className = "notify-result visible err";
        };
      }

      updateThemeIcon();
      loadConfig();

      // Control tab is default — start polling immediately
      updateConnectionStatus();
      statusPollInterval = setInterval(updateConnectionStatus, 3000);
    </script>
  </body>
</html>
